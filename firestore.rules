
/**
 * This ruleset enforces a security model for a comprehensive marketplace application.
 * The core philosophy is to provide strict authorization based on user roles and
 * relationships (guest, host) while allowing flexibility in data schemas for rapid prototyping.
 *
 * Core Philosophy:
 * - Public data, like cultural experiences and reviews, is publicly readable to encourage discovery.
 * - Private user data, such as host profiles, is strictly confined to the owner.
 * - Transactional data, including bookings and messages, is accessible only to the direct participants involved.
 * - Administrative logs are completely inaccessible to client applications.
 *
 * Data Structure:
 * - User-specific data is organized under a user's private space (e.g., /users/{userId}/hosts/{hostId}).
 * - Public and transactional data are stored in top-level collections for straightforward querying.
 *
 * Key Security Decisions:
 * - Denormalization for Authorization: To ensure performant and secure access checks, documents contain
 *   the necessary user IDs (e.g., guestId, hostId) directly. This avoids slow and costly `get()` calls in rules.
 * - Disallowing Broad List Operations: For collections containing sensitive, multi-user data like bookings
 *   and messages, general `list` operations are disabled. This forces the client application to build
 *   specific, secure queries (e.g., fetching bookings for a specific guestId) that can be properly secured.
 * - Strict Ownership for Writes: All write operations (create, update, delete) are protected by
 *   verifying the user's identity against ownership fields on the documents.
 * - Structural Segregation: User-specific data (Host profiles) is kept in a user-scoped subcollection,
 *   which provides a clear and secure boundary from public-facing data like Experiences.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the primary function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    /**
     * Checks if the user has admin privileges.
     */
    function isAdmin() {
      return request.auth.uid == '9vjYTvqyLHSOZj27shGfhgpwgDw1';
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------
    
    /**
     * @description Manages public user profiles and their subcollections (hosts, wishlist).
     * @path /users/{userId}
     */
    match /users/{userId} {
      /**
       * @description A user's public profile data.
       * @allow (get) Any user can view any other user's public profile.
       * @allow (update) A user can only update their own profile.
       */
      allow get: if true;
      allow list: if isAdmin(); // Allow listing only for admin UI
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin(); // Allow updates by owner or by an admin
      allow delete: if isOwner(userId) || isAdmin();

      /**
       * @description Secures a user's private host profile. Only the owner can manage their profile.
       * @path /users/{userId}/hosts/{hostId}
       */
      match /hosts/{hostId} {
        allow get: if true;
        allow list: if isOwner(userId);
        allow create: if isOwner(userId) || isAdmin(); // Allow creation by owner or by an admin
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
      }
      
      /**
       * @description Secures a user's private wishlist. Only the owner can manage it.
       * @path /users/{userId}/wishlist/{experienceId}
       */
      match /wishlist/{experienceId} {
        allow read, write: if isOwner(userId);
      }
    }

     /**
     * @description Manages host applications.
     * @path /hostApplications/{applicationId}
     */
    match /hostApplications/{applicationId} {
      // Any authenticated user can create an application for themselves.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      // Only admins can read, list, and update applications.
      allow get, list, update: if isAdmin();
      allow delete: if false; 
    }

    /**
     * @description Manages cultural experiences. Experiences are public to view, but only the host who created it or an admin can manage it.
     * @path /experiences/{experienceId}
     */
    match /experiences/{experienceId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && (resource.data.hostId == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && (resource.data.hostId == request.auth.uid || isAdmin());
    }

    /**
     * @description Secures bookings. Only the guest who made the booking, the host of the experience, or an admin can view or modify the booking.
     * @path /bookings/{bookingId}
     */
    match /bookings/{bookingId} {
      allow get: if isSignedIn() && (resource.data.guestId == request.auth.uid || resource.data.hostId == request.auth.uid || isAdmin());
      allow list: if isAdmin();
      allow create: if isSignedIn() && request.resource.data.guestId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.guestId == request.auth.uid || resource.data.hostId == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && (resource.data.guestId == request.auth.uid || resource.data.hostId == request.auth.uid || isAdmin());
    }

    /**
     * @description Manages reviews. Reviews are public to read, but only the guest who wrote it or an admin can manage it.
     * @path /reviews/{reviewId}
     */
    match /reviews/{reviewId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.guestId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.guestId == request.auth.uid || isAdmin());
      allow delete: if isSignedIn() && (resource.data.guestId == request.auth.uid || isAdmin());
    }

    /**
     * @description Secures private messages between a sender and a receiver.
     * @path /messages/{messageId}
     */
    match /messages/{messageId} {
      // Admins have full read access for moderation.
      allow get, list: if isAdmin();

      // Users can read messages they are a part of.
      // For `get`, it checks the document.
      // For `list`, it requires a `where('participants', 'array-contains', request.auth.uid)` clause in the query.
      allow read: if isSignedIn() && request.auth.uid in resource.data.participants;

      // A user can create a message if they are the sender and included in the `participants` array.
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid && request.auth.uid in request.resource.data.participants;

      // Only the sender or an admin can update or delete messages.
      allow update, delete: if isSignedIn() && (resource.data.senderId == request.auth.uid || isAdmin());
    }

    /**
     * @description Manages user-submitted reports and system flags.
     * @path /reports/{reportId}
     */
    match /reports/{reportId} {
      // Only admins can read/write reports.
      allow read, write: if isAdmin();
    }

    /**
     * @description Locks down administrator logs. No client-side access is permitted.
     * @path /admin_logs/{adminLogId}
     */
    match /admin_logs/{adminLogId} {
      allow read, write: if false;
    }

    /**
     * @description Manages discount coupons.
     * @path /coupons/{couponId}
     */
    match /coupons/{couponId} {
      // Any signed-in user can read a coupon to validate it.
      allow get: if isSignedIn();
      // Only admins can see the full list of coupons, create, or delete them.
      allow list, create, delete: if isAdmin();
      // Admins can update any field.
      // Users can only update the timesUsed field as part of a transaction.
      allow update: if isAdmin() || (
        isSignedIn() &&
        request.writeFields.size() == 1 && 'timesUsed' in request.writeFields
      );
    }
  }
}

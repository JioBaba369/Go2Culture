
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function isParticipant(doc) {
      return isSignedIn() && request.auth.uid in doc.participants;
    }

    function isBookingParticipant(booking) {
      return isSignedIn() && (request.auth.uid == booking.guestId || request.auth.uid == booking.hostId);
    }

    // NOTE: Hardcoded Admin UID. In production, consider a 'role' field in /users/{userId}
    function isAdmin() {
      return request.auth != null && request.auth.uid == '9vjYTvqyLHSOZj27shGfhgpwgDw1';
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------
    
    match /users/{userId} {
      allow get: if true;
      allow list: if isAdmin(); 
      allow create: if isOwner(userId);
      // Allow users to update their own profile, including termsAccepted
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin(); // Only Admin should delete users

      match /hosts/{hostId} {
        allow get: if true;
        allow list: if isOwner(userId) || isAdmin();
        // Allow hosts to update their own compliance fields
        allow create, update, delete: if isOwner(userId) || isAdmin();
      }
      
      match /wishlist/{experienceId} {
        allow read, write: if isOwner(userId);
      }
    }

    match /hostApplications/{applicationId} {
      // NOTE: Ensure your frontend sends 'userId' field matching the auth UID
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow get, list, update: if isAdmin();
      allow delete: if isAdmin(); 
    }

    match /experiences/{experienceId} {
      allow get, list: if true; // Public discovery
      allow create: if isSignedIn();
      // Only the host or Admin can edit/delete
      allow update, delete: if isSignedIn() && (resource.data.hostId == request.auth.uid || isAdmin());
    }

    match /bookings/{bookingId} {
      // Only participants or Admin
      allow get: if isBookingParticipant(resource.data) || isAdmin();
      // List requires a query filter by guestId or hostId to be secure, or be an admin
      allow list: if isAdmin() || (isSignedIn() && request.query.limit <= 50 && (request.query.where.guestId == request.auth.uid || request.query.where.hostId == request.auth.uid));
      // User must agree to terms to book
      allow create: if isSignedIn() && request.resource.data.guestId == request.auth.uid && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.termsAccepted == true;
      allow update: if isBookingParticipant(resource.data) || isAdmin();
      allow delete: if isAdmin(); // Prevent users from wiping transaction history
    }

    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.guestId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.guestId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    match /messages/{messageId} {
      allow read: if isAdmin() || isParticipant(resource.data);
      allow create: if isSignedIn() && (request.resource.data.senderId == request.auth.uid);
      allow update: if isSignedIn() && (resource.data.senderId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }
    
    match /conversations/{bookingId} {
      // Read permissions
      allow get: if isAdmin() || isParticipant(resource.data);
      allow list: if isAdmin(); // Blanket list for admins

      // Write permissions
      allow create: if isAdmin() || isParticipant(request.resource.data);
      allow update: if isAdmin() || isParticipant(resource.data);
      allow delete: if isAdmin();
    }

    match /sponsors/{sponsorId} {
      // Allow public read for everyone, but only admins can write.
      allow read: if true;
      allow write: if isAdmin();
    }

    match /coupons/{couponId} {
      allow get: if isSignedIn();
      allow list, create, delete: if isAdmin();
      // Allow user to increment usage count without allowing them to change the discount value
      allow update: if isAdmin() || (
        isSignedIn() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['timesUsed'])
      );
    }
    
    // Admin only sections
    match /reports/{reportId} { allow read, write: if isAdmin(); }
    match /admin_logs/{adminLogId} { allow read, write: if false; }
  }
}

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------
    // Helper Functions
    // --------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    // NOTE: Hardcoded Admin UID. In production, consider a 'role' field in /users/{userId}
    function isAdmin() {
      return request.auth != null && request.auth.uid == '9vjYTvqyLHSOZj27shGfhgpwgDw1';
    }

    // --------------------------------
    // Collection Rules
    // --------------------------------
    
    match /users/{userId} {
      allow get: if true;
      allow list: if isAdmin(); 
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin(); // Only Admin should delete users

      match /hosts/{hostId} {
        allow get: if true;
        allow list: if isOwner(userId) || isAdmin();
        allow create: if isOwner(userId) || isAdmin();
        allow update, delete: if isOwner(userId) || isAdmin();
      }
      
      match /wishlist/{experienceId} {
        allow read, write: if isOwner(userId);
      }
    }

    match /hostApplications/{applicationId} {
      // NOTE: Ensure your frontend sends 'userId' field matching the auth UID
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow get, list, update: if isAdmin();
      allow delete: if isAdmin(); 
    }

    match /experiences/{experienceId} {
      allow get, list: if true; // Public discovery
      allow create: if isSignedIn();
      // Only the host or Admin can edit/delete
      allow update, delete: if isSignedIn() && (resource.data.hostId == request.auth.uid || isAdmin());
    }

    match /bookings/{bookingId} {
      // Only participants or Admin
      allow get: if isSignedIn() && (resource.data.guestId == request.auth.uid || resource.data.hostId == request.auth.uid || isAdmin());
      // List requires a query filter by guestId or hostId to be secure
      allow list: if isSignedIn() && (request.query.limit <= 50) && (request.query.where.guestId == request.auth.uid || request.query.where.hostId == request.auth.uid || isAdmin());
      allow create: if isSignedIn() && request.resource.data.guestId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.guestId == request.auth.uid || resource.data.hostId == request.auth.uid || isAdmin());
      allow delete: if isAdmin(); // Prevent users from wiping transaction history
    }

    match /reviews/{reviewId} {
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.guestId == request.auth.uid;
      allow update: if isSignedIn() && (resource.data.guestId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    match /messages/{messageId} {
      function isBookingParticipant() {
        let bookingId = request.query.where.bookingId;
        // NOTE: Client MUST filter by bookingId or the 'list' will fail
        return bookingId != null && 
               get(/databases/$(database)/documents/bookings/$(bookingId)).data.guestId == request.auth.uid ||
               get(/databases/$(database)/documents/bookings/$(bookingId)).data.hostId == request.auth.uid;
      }
      
      allow get: if isAdmin() || (isSignedIn() && request.auth.uid in resource.data.participants);
      allow list: if isAdmin() || (isSignedIn() && (request.auth.uid in resource.data.participants || isBookingParticipant()));
      allow create: if isSignedIn() && (request.resource.data.senderId == request.auth.uid);
      allow update: if isSignedIn() && (resource.data.senderId == request.auth.uid || isAdmin());
      allow delete: if isAdmin();
    }

    match /sponsors/{sponsorId} {
      // FIX: Added 'true' check to get, and made list more flexible
      allow get: if (resource.data.isActive == true) || isAdmin() || !exists(resource);
      
      // FIX: This now allows listing if the user filters for active sponsors
      // or if they are an admin.
      allow list: if isAdmin() || (isSignedIn() && request.query.where.isActive == true);

      allow write: if isAdmin();
    }

    match /coupons/{couponId} {
      allow get: if isSignedIn();
      allow list, create, delete: if isAdmin();
      // Allow user to increment usage count without allowing them to change the discount value
      allow update: if isAdmin() || (
        isSignedIn() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['timesUsed'])
      );
    }
    
    // Admin only sections
    match /reports/{reportId} { allow read, write: if isAdmin(); }
    match /admin_logs/{adminLogId} { allow read, write: if false; }
  }
}
